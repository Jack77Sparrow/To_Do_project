<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="static/tasks_styles.css?v=4" />
    <title>Tasks</title>

    <script>

      let currentPage = 1;
      let currentTaskId = null;
      const limit = 15;
      let filters = {
        status: null,
        priority: null,
        difficulty: null,
      };
      let sortBy = "created_at";
      let sortOrder = "desc";

      async function loadTasks(page = 1) {
        currentPage = page;

        const params = new URLSearchParams({
          page,
          limit,
          sort_by: sortBy,
          order: sortOrder,
        });

        if (filters.status) params.append("status", filters.status);
        if (filters.priority) params.append("priority", filters.priority);
        if (filters.difficulty) params.append("difficulty", filters.difficulty);

        const url = `http://127.0.0.1:8000/tasks?${params.toString()}`;

        console.log("FETCH:", url);

        const response = await fetch(url);
        const data = await response.json();

        const list = document.getElementById("task-list");
        list.innerHTML = "";

        data.items.forEach((task) => {
          const item = document.createElement("div");
          item.className = "task-item";
          item.onclick = () => loadTaskDetails(task.id);
          const difficulty = task.difficulty
            ? task.difficulty.toLowerCase()
            : "";

          item.innerHTML = `
            <div class="task-left">
              <img src="../static/images/icons/to-do.png" class="task-icon" />
              <div class="task-title">${task.title}</div>
            </div>
            <div class="task-difficult ${difficulty}">
              ${difficulty || "-"}
            </div>
            <div class="task-tag">${task.category || "-"}</div>
          `;

          list.appendChild(item);
        });

        renderPagination(data.total, data.page, data.limit);
        console.log(data.total);
      }

      function startTimer() {
        if (!currentTaskId) return;
        fetch(`http://127.0.0.1:8000/tasks/${currentTaskId}/start`, {
          method: "POST",
        });
      }

      function stopTimer() {
        if (!currentTaskId) return;
        const response = fetch(
          `http://127.0.0.1:8000/tasks/${currentTaskId}/stop`,
          {
            method: "POST",
          },
        );
      }

      function renderPagination(total, page, limit) {
        const pages = Math.ceil(total / limit);
        console.log(pages);
        const container = document.getElementById("pagination");
        container.innerHTML = "";

        for (let i = 1; i <= pages; i++) {
          const btn = document.createElement("button");
          btn.innerText = i;
          if (i === page) btn.classList.add("active");
          btn.onclick = () => loadTasks(i);
          container.appendChild(btn);
        }
      }

      async function loadTaskDetails(id) {
        currentTaskId = id;

        const response = await fetch(`http://127.0.0.1:8000/tasks/${id}`);
        const task = await response.json();
        console.log(task.due_to);
        document.getElementById("details-title").innerText = task.title;
        document.getElementById("details-due").value = task.due_to || "-";

        document.getElementById("details-priority").value =
          task.priority || "low";
        document.getElementById("details-status").value =
          task.status || "pending";
        document.getElementById("details-desc").value = task.description || "";

        document.getElementById("details-created").innerText =
          task.created_at || "‚Äî";
        document.getElementById("details-updated").innerText =
          task.last_updated || "‚Äî";
        
        toggleEdit(false);
      }

      function toggleEdit(enable) {
        const editBtn = document.getElementById("edit-btn");
        const editActions = document.getElementById("edit-actions");

        document
          .querySelectorAll(
            "#details-due, #details-priority, #details-status, #details-desc",
          )
          .forEach((el) => (el.disabled = !enable));

        if (editBtn) {
          editBtn.classList.toggle("hidden", enable);
        }

        if (editActions) {
          editActions.classList.toggle("hidden", !enable);
        }
      }

      async function deleteTask() {
        console.log(currentTaskId);
        const response = await fetch(
          `http://127.0.0.1:8000/tasks/${currentTaskId}`,
          {
            method: "DELETE",
          },
        );
        if (!response.ok) {
          throw new Error("Failed to delete task");
        }

        currentTaskId = null;

        await loadTasks();
      }

      async function saveTask() {
        const payload = {
          due_to: document.getElementById("details-due").value,
          priority: document.getElementById("details-priority").value,
          status: document.getElementById("details-status").value,
          description: document.getElementById("details-desc").value,
        };

        await fetch(`http://127.0.0.1:8000/tasks/${currentTaskId}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        toggleEdit(false);
        loadTaskDetails(currentTaskId);
      }
      function renderTasks(tasks) {
        const container = document.getElementById("tasks");
        container.innerHTML = "";

        tasks.forEach((task) => {
          const div = document.createElement("div");
          div.textContent = task.title;
          container.appendChild(div);
        });
      }

      window.onload = () => loadTasks();

      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".difficulty-tabs .tab").forEach((btn) => {
          btn.addEventListener("click", () => {
            document
              .querySelectorAll(".difficulty-tabs .tab")
              .forEach((b) => b.classList.remove("active"));

            btn.classList.add("active");

            filters.difficulty = btn.dataset.value || null;

            loadTasks(1);
          });
        });
      });
      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".priority-tabs .tab").forEach((btn) => {
          btn.addEventListener("click", () => {
            document
              .querySelectorAll(".priority-tabs .tab")
              .forEach((b) => b.classList.remove("active"));

            btn.classList.add("active");

            filters.priority = btn.dataset.value || null;

            loadTasks(1);
          });
        });
      });
      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".status-tabs .tab").forEach((btn) => {
          btn.addEventListener("click", () => {
            document
              .querySelectorAll(".status-tabs .tab")
              .forEach((b) => b.classList.remove("active"));

            btn.classList.add("active");

            filters.status = btn.dataset.value || null;

            loadTasks(1);
          });
        });
      });
      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM READY");

        document.querySelectorAll(".sort-by-tabs .tab").forEach((btn) => {
          btn.addEventListener("click", () => {
            console.log("CLICK SORT:", btn.dataset.sort);

            sortBy = btn.dataset.sort;

            btn.parentElement
              .querySelectorAll(".tab")
              .forEach((b) => b.classList.remove("active"));

            btn.classList.add("active");

            loadTasks(1);
          });
        });

        document.querySelectorAll(".order-tabs .tab").forEach((btn) => {
          btn.addEventListener("click", () => {
            console.log("CLICK ORDER:", btn.dataset.order);

            sortOrder = btn.dataset.order;

            btn.parentElement
              .querySelectorAll(".tab")
              .forEach((b) => b.classList.remove("active"));

            btn.classList.add("active");

            loadTasks(1);
          });
        });
      });
    </script>
  </head>

  <body>
    <div class="page-grid">
      <!-- ===== FILTERS ===== -->
      <aside class="filters">
        <h3 class="filters-title">Filters</h3>

        <div class="filter-group">
          <div class="filter-label">Status</div>
          <div class="tabs status-tabs">
            <button class="tab active" data-value="">All</button>
            <button class="tab" data-value="pending">Pending</button>
            <button class="tab" data-value="in progress">In progress</button>
            <button class="tab" data-value="done">Done</button>
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-label">Priority</div>
          <div class="tabs priority-tabs">
            <button class="tab active" data-value="">All</button>
            <button class="tab" data-value="low">Low</button>
            <button class="tab" data-value="medium">Medium</button>
            <button class="tab" data-value="high">High</button>
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-label">Difficulty</div>
          <div class="tabs difficulty-tabs">
            <button class="tab active" data-value="">All</button>
            <button class="tab" data-value="easy">Easy</button>
            <button class="tab" data-value="medium">Medium</button>
            <button class="tab" data-value="hard">Hard</button>
          </div>
        </div>

        <h3 class="filters-title">Sorting</h3>

        <div class="filter-group">
          <div class="filter-label">Sort by</div>
          <div class="tabs sort-by-tabs">
            <button class="tab active" data-sort="created_at">Created</button>
            <button class="tab" data-sort="updated_at">Updated</button>
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-label">Order</div>
          <div class="tabs order-tabs">
            <button class="tab active" data-order="desc">Newest</button>
            <button class="tab" data-order="asc">Oldest</button>
          </div>
        </div>
      </aside>

      <!-- ===== TASK LIST ===== -->
      <section class="left-page">
        <div id="task-list" class="task-list">
          <!-- tasks rendered by JS -->
        </div>
      </section>

      <!-- ===== TASK DETAILS ===== -->
      <section class="right-page">
        <div class="card-header">
          <h1 id="details-title">Select a task</h1>

          <div>
            <button class="header-btn" id="edit-btn" onclick="toggleEdit(true)">
              ‚úèÔ∏è Edit
            </button>
            <button class="header-btn delete" onclick="deleteTask()">
              üóë Delete
            </button>
          </div>
        </div>

        <div class="task-info">
          <div>
            <div class="label">Due</div>
            <input type="date" id="details-due" placeholder="–¥–¥.–º–º.—Ä—Ä—Ä—Ä" />
          </div>

          <div>
            <div class="label">Priority</div>
            <select id="details-priority" disabled>
              <option value="low">low</option>
              <option value="medium">medium</option>
              <option value="high">high</option>
            </select>
          </div>

          <div>
            <div class="label">Status</div>
            <select id="details-status" disabled>
              <option value="pending">pending</option>
              <option value="in progress">in progress</option>
              <option value="done">done</option>
            </select>
          </div>
        </div>

        <div class="task-description">
          <h3>Description</h3>
          <textarea
            id="details-desc"
            rows="5"
            placeholder="Write task details here..."
            disabled
          ></textarea>
        </div>

        <div class="task-actions hidden" id="edit-actions">
          <button class="btn-secondary" onclick="toggleEdit(false)">
            Cancel
          </button>
          <button class="btn-primary" onclick="saveTask()">Save changes</button>
        </div>

        <div class="task-meta">
          <div class="datetimes">
            <div>
              <span class="meta-label">Created:</span>
              <span id="details-created">‚Äî</span>
            </div>
            <div>
              <span class="meta-label">Last updated:</span>
              <span id="details-updated">‚Äî</span>
            </div>
          </div>

          <div class="timer">
            <button class="start-btn" onclick="startTimer()">Start</button>
            <button class="stop-btn" onclick="stopTimer()">Stop</button>
          </div>
        </div>
      </section>
    </div>

    <!-- ===== PAGINATION ===== -->
    <div id="pagination" class="pagination"></div>
  </body>
</html>
